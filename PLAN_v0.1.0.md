# Portfolio 60 v0.1.0 — Implementation Plan

## Summary
Build the UK family investment portfolio tracker from an empty directory through 9 phases with 7 manual testing pauses, following the CLAUDE.md specification at `/home/rcollins/code/portfolio_60/CLAUDE.md`.

## Key Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Password hashing | `Bun.password` (built-in argon2id) | Zero dependencies, secure default |
| TailwindCSS v4 build | `@tailwindcss/cli` (not PostCSS) | Simpler — no postcss.config.js needed |
| Currency rate source | Frankfurter API (`api.frankfurter.dev`) | Free, no API key, ECB data, JSON API |
| Currency rate fetch | Native `fetch()` | JSON API, no browser needed |
| Price scraping | Playwright headless Chromium | Needs full page render for CSS selectors |
| Playwright + Bun compat | Run scraper via subprocess (Node.js fallback) | Playwright not fully Bun-native |
| Router | Simple regex-based custom router | Avoids Express/Hono dependency |
| Database | `bun:sqlite` built-in, WAL mode | Zero dependencies, fast |

## Dependencies

```bash
# Production
bun add tailwindcss @tailwindcss/cli concurrently

# Development
bun add -d playwright @playwright/test

# Browser binary
bunx playwright install chromium

# Tauri (requires Rust toolchain pre-installed)
# Scaffold via: bunx create-tauri-app
```

Built-in (zero install): `bun:sqlite`, `Bun.password`, `Bun.serve()`, `Bun.file()`, `fetch()`

---

## Phase 1: Scaffolding (Milestones 1-2)

**Goal**: Bun project + Tauri v2 shell + TailwindCSS v4 pipeline + working HTTP server + base HTML with navigation.

**Files to create:**
- `package.json` — scripts: `dev`, `dev:server`, `dev:css`, `build:css`, `test`, `test:e2e`, `tauri:dev`, `tauri:build`
- `.gitignore` — node_modules, .env, data/, backups/, output.css, src-tauri/target/
- `bunfig.toml` — test root = `./tests`
- `src-tauri/tauri.conf.json` — devUrl: `http://localhost:1420`, beforeDevCommand: `bun run dev`, window 1536x864
- `src-tauri/Cargo.toml`, `src-tauri/src/main.rs` — generated by Tauri scaffold
- `src/ui/css/input.css` — `@import "tailwindcss";`
- `src/ui/index.html` — base template with nav bar (Home, Users, Investments, Currencies, Global Events, Scraping, Backup), light theme, UK English
- `src/ui/js/app.js` — active nav highlighting, API fetch wrapper, message display helpers
- `src/ui/pages/*.html` — placeholder pages for each nav item
- `src/server/index.js` — `Bun.serve()` on port 1420, static file serving via `Bun.file()`, API route placeholder
- `src/shared/constants.js` — APP_NAME, APP_VERSION, SERVER_PORT, DB_PATH, BACKUP_DIR, CURRENCY_SCALE_FACTOR (10000)
- `tests/unit/server.test.js` — server responds, static files served, 404 for unknown routes

**Commands:**
```bash
bun init -y && git init
bun add tailwindcss @tailwindcss/cli concurrently
bun add -d playwright @playwright/test
bunx create-tauri-app  # scaffold into src-tauri/
bun run build:css       # verify TailwindCSS pipeline
bun run dev             # verify server + CSS watcher
```

---

## Phase 2: Security (Milestone 3)

**Goal**: Passphrase gate — first run sets passphrase, subsequent runs verify before serving UI/data. Scraper routes unprotected.

**Files to create:**
- `.env.example` — template with `APP_PASSPHRASE_HASH=`
- `src/server/auth.js` — `isFirstRun()`, `hashPassphrase()` (Bun.password.hash), `verifyPassphrase()` (Bun.password.verify), `saveHashToEnv()`, `loadHashFromEnv()`, in-memory `isAuthenticated` flag
- `src/server/middleware/auth-middleware.js` — checks auth state; unprotected prefixes: `/api/auth/`, `/api/scraper/`, `/css/`, `/js/`
- `src/server/routes/auth-routes.js` — `GET /api/auth/status`, `POST /api/auth/set-passphrase`, `POST /api/auth/verify`
- `src/ui/pages/passphrase.html` — dual-mode: set passphrase (first run) or verify (subsequent)
- `src/ui/js/passphrase.js` — form logic, calls auth API, redirects on success
- `tests/unit/auth.test.js` — hash/verify, env read/write
- `tests/unit/auth-routes.test.js` — API endpoint tests, auth gate enforcement

**Modify:** `src/server/index.js` — integrate auth middleware, redirect unauthenticated requests to passphrase page

---

## Phase 3: Database (Milestones 4-5)

**Goal**: SQLite database creation with all tables, indexes, constraints, and seed data. UI flow for first-time setup.

**Files to create:**
- `src/server/db/schema.sql` — all 6 tables (users, investment_types, currencies, investments, currency_rates, global_events) with CHECK constraints, FKs, UNIQUE constraints, indexes
- `src/server/db/seed.sql` — 5 investment_types + GBP currency
- `src/server/db/connection.js` — `databaseExists()`, `createDatabase()` (runs schema + seed), `getDatabase()` (singleton, WAL mode, FK pragma), `closeDatabase()`
- `src/server/routes/db-routes.js` — `GET /api/db/status`, `POST /api/db/create`
- `tests/unit/db.test.js` — tables exist, seed data correct, FK enforcement, unique constraints, WAL mode

**Modify:** `src/server/index.js` — register db routes, check DB on startup. Home page (`index.html`) — check DB status, prompt creation if missing, show confirmation.

### PAUSE 1: Manual Testing
- Server starts, passphrase flow works, database creates correctly
- All 6 tables exist, seed data present (5 investment types + GBP)
- `bun test` passes

---

## Phase 4: Users CRUD (Milestone 6)

**Goal**: Full add/amend/delete for users with validation.

**Files to create:**
- `src/server/db/users-db.js` — `getAllUsers()`, `getUserById()`, `createUser()`, `updateUser()`, `deleteUser()`
- `src/server/validation.js` — `validateRequired()`, `validateMaxLength()`, `validateUser()`
- `src/server/routes/users-routes.js` — GET/POST/PUT/DELETE `/api/users` and `/api/users/:id`
- `src/server/router.js` — simple regex-based route matching with parameter extraction
- `src/ui/pages/users.html` — table display, add/edit form, delete confirmation
- `src/ui/js/users.js` — fetch data, populate table, form handling, validation, CRUD operations
- `tests/unit/users-db.test.js` — all CRUD operations, validation
- `tests/unit/users-routes.test.js` — API endpoint tests

**Modify:** `src/server/index.js` — use Router class, register user routes

### PAUSE 2: Manual Testing
- Users CRUD works end-to-end, form validation, data persists across restarts

---

## Phase 5: Investments CRUD (Milestone 7)

**Goal**: Full CRUD with FK dropdowns for currency and investment type.

**Files to create:**
- `src/server/db/investments-db.js` — CRUD with JOIN queries (currency + type details)
- `src/server/db/investment-types-db.js` — `getAllInvestmentTypes()` (read-only)
- `src/server/routes/investments-routes.js` — CRUD endpoints + `GET /api/investment-types`
- `src/ui/pages/investments.html` — table with type/currency columns, form with dropdowns
- `src/ui/js/investments.js` — populate dropdowns from API, CRUD logic, helper text for URL/selector fields
- `tests/unit/investments-db.test.js` — CRUD, FK constraints

**URL/selector helper text**: "To find the CSS selector: right-click the price on the web page, choose 'Inspect', then right-click the highlighted element and choose 'Copy > Copy selector'."

### PAUSE 3: Manual Testing
- Dropdowns populated correctly, FK integrity enforced, URL/selector fields clear

---

## Phase 6: Currencies + Global Events CRUD (Milestones 8-9)

**Goal**: CRUD for both entities. GBP protected from deletion.

**Files to create:**
- `src/server/db/currencies-db.js` — CRUD (delete checks FK usage + protects GBP)
- `src/server/routes/currencies-routes.js` — CRUD endpoints, code auto-uppercase, 3-char validation
- `src/ui/pages/currencies.html` + `src/ui/js/currencies.js` — table, form, GBP marked as "Base currency" with no delete button
- `src/server/db/global-events-db.js` — CRUD, ordered by date DESC
- `src/server/routes/global-events-routes.js` — CRUD endpoints, date validation (ISO-8601)
- `src/ui/pages/global-events.html` + `src/ui/js/global-events.js` — table (reverse chronological), form with date picker defaulting to today
- `tests/unit/currencies-db.test.js`, `tests/unit/global-events-db.test.js`

### PAUSE 4: Manual Testing
- Currencies: GBP protected, unique code enforced, new currencies appear in investments dropdown
- Global events: date ordering, add/edit/delete work

---

## Phase 7: Currency Rate Scraping (Milestone 10)

**Goal**: Fetch exchange rates from Frankfurter API, store as INTEGER x 10000, INSERT OR REPLACE.

**Files to create:**
- `src/server/scrapers/currency-scraper.js` — `fetchCurrencyRates()`: get non-GBP currencies from DB, call `https://api.frankfurter.dev/v1/latest?base=GBP&symbols=...`, scale rates by x 10000, INSERT OR REPLACE
- `src/server/db/currency-rates-db.js` — `getLatestRates()`, `getRatesForDate()`, `getRateHistory()`
- `src/server/routes/scraper-routes.js` — `POST /api/scraper/currency-rates` (unprotected), `GET /api/scraper/currency-rates/latest`
- `src/ui/pages/scraping.html` + `src/ui/js/scraping.js` — "Fetch Currency Rates" button, results table, placeholder for price scraping section
- `tests/unit/currency-scraper.test.js` — scaling logic, INSERT OR REPLACE, empty currencies, mock fetch

### PAUSE 5: Manual Testing
- Rates fetched and displayed correctly, overwrite on re-fetch, correct integer scaling in DB

---

## Phase 8: Price Scraping (Milestone 11)

**Goal**: Playwright scraper for investment prices. Always fetches currency rates first.

**Files to create:**
- `src/server/scrapers/price-scraper.js` — `scrapeAllPrices()`: calls `fetchCurrencyRates()` first, then launches Playwright Chromium, visits each investment URL, extracts price via CSS selector, parses numeric value. `scrapeSinglePrice(id)` for individual investment.
- `src/server/scrapers/price-scraper-runner.js` — standalone Node.js-compatible runner (subprocess for Bun compatibility)
- `tests/unit/price-scraper.test.js` — price text parsing, error handling, currency-rates-first coupling

**Modify:**
- `src/server/routes/scraper-routes.js` — add `POST /api/scraper/prices`, `POST /api/scraper/prices/:id`
- `src/ui/js/scraping.js` — "Fetch All Prices" button, per-investment results table with status, progress indicator

**Price parsing**: Strip currency symbols, commas, whitespace then `parseFloat()`. Handle pence notation (e.g. "123.45p").

### PAUSE 6: Manual Testing
- Test with real URLs (e.g. HL fund page, LSE share price)
- Currency rates refreshed before price scrape
- Error handling for invalid URLs/selectors
- Individual investment re-scrape works

---

## Phase 9: Backup/Restore (Milestone 12)

**Goal**: One-click backup (timestamped SQLite copy), one-click restore with confirmation.

**Files to create:**
- `src/server/db/backup.js` — `createBackup()` (WAL checkpoint, copy to `backups/portfolio60_YYYY-MM-DDTHH-MM-SS.db`), `restoreBackup(filename)` (close DB, copy over, reopen), `listBackups()` (sorted newest first)
- `src/server/routes/backup-routes.js` — `GET /api/backups`, `POST /api/backups`, `POST /api/backups/restore`
- `src/ui/pages/backup.html` + `src/ui/js/backup.js` — "Create Backup" button, backups list table, restore button with confirmation dialog, warning text
- `tests/unit/backup.test.js` — backup creates file, list returns backups, restore replaces DB with correct data

### PAUSE 7: Final Manual Testing
Full end-to-end walkthrough:
1. Fresh start (delete .env, data/, backups/)
2. Set passphrase -> create database -> add currencies (USD, EUR) -> add users -> add investments (with real URLs/selectors) -> add global events
3. Fetch currency rates -> fetch prices -> verify results
4. Create backup -> modify data -> restore -> verify original data restored
5. Restart app -> passphrase prompt -> data persists
6. `bun test` passes all tests
7. `bun run tauri:dev` opens desktop window correctly

---

## Verification

After all phases complete:
1. `bun test` — all unit tests pass
2. `bun run dev` — server starts on port 1420, CSS watcher runs
3. Manual walkthrough of PAUSE 7 checklist above
4. `bun run tauri:dev` — Tauri desktop window opens and wraps the app correctly
